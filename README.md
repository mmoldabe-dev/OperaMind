# OperaMind

Аналитическая платформа для обработки телефонных/аудио разговоров: загрузка файла → транскрипция → интеллектуальный анализ (Gemini) → отчёт.

## Возможности
- Авторизация пользователя (Flask-Login)
- Загрузка аудио (`mp3`, `wav`, `m4a`, `ogg`) и текстовых (`txt`) файлов
- Транскрипция через Google Speech Recognition
- Структурированная транскрипция (диалог): сегменты, эвристическое определение ролей (клиент / оператор)
- Почти поминутные таймкоды (эвристика распределения по предложениям)
- Псевдо word-level разметка (каждому слову присвоен интервал внутри сегмента)
- Анализ через Google Gemini (тональность, тема, ключевые слова, рекомендации и т.д.)
- История обработанных разговоров
- Отчёт в формате TXT (теперь диалог с таймкодами)

## Планы расширения
Для точной диаризации и словарных таймкодов можно подключить:
- `pyannote.audio` (speaker diarization)
- `Vosk` или `Whisper` (точная сегментация + слова + спикеры через доп. пайплайн)

## Архитектура
```
app.py          - Flask маршруты и оркестрация
models.py       - SQLAlchemy модели (User, Conversation, Analysis)
transcriber.py  - Расширенная транскрипция + структурирование
analyzer.py     - Взаимодействие с Gemini (модели 2.x)
init_db.py      - Инициализация БД и демо-пользователь
templates/      - HTML шаблоны
uploads/        - Загруженные файлы
instance/       - SQLite база (operamind.db)
```

## Установка
```bash
python3.11 -m venv .venv
source .venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
```

FFmpeg (для pydub):
```bash
brew install ffmpeg
```

## Конфигурация (.env)
Создайте файл `.env` в корне:
```
SECRET_KEY=замените-на-уникальный-ключ
GEMINI_API_KEY=ваш_ключ_Gemini
VOSK_MODEL_PATH=/absolute/path/to/vosk-model-ru
PAUSE_THRESHOLD=0.8
SPEAKER_CLUSTERING=1
```

## Инициализация БД
```bash
python init_db.py
```
Логин по умолчанию: `operator` / `demo123`.

## Запуск
```bash
python app.py
```
Откройте: http://127.0.0.1:5000/login

## Структурированная транскрипция
При успешной транскрипции поле `Analysis.transcript` теперь содержит JSON:
```json
{
  "text": "полный плоский текст",
  "segments": [
    {
      "index": 0,
      "speaker": "client",
      "start": 0.0,
      "end": 3.42,
      "text": "Здравствуйте...",
      "words": [ {"w": "Здравствуйте", "start": 0.0, "end": 0.6} ],
      "gap_from_prev": 0.0
    }
  ],
  "meta": {
    "duration_sec": 12.345,
    "method": "google_speech + heuristic segmentation"
  }
}
```
Отображение в интерфейсе происходит как чат: аватар (CL/OP), таймкоды, паузы и слова с подсказками по времени.

## Ограничения текущей версии
- Без Vosk: спикеры определяются эвристически (чередование).
- С Vosk: точные таймкоды слов, но роли всё ещё эвристические (можно улучшить).
- Реальной акустической диаризации (голосовых эмбеддингов) нет.
- Для длинных файлов Google API может вернуть усечённый результат.

## Использование Vosk (оффлайн распознавание)
1. Скачайте русскую модель, например с https://alphacephei.com/vosk/models (пример: `vosk-model-small-ru-0.22`).
2. Распакуйте и укажите путь в `.env` переменной `VOSK_MODEL_PATH`.
3. При наличии модели и установленного пакета `vosk` транскрипция будет выполняться оффлайн.
4. В `meta.method` появится `"vosk"`.
5. Улучшение ролей: можно анализировать термины приветствия ("здравствуйте", "добрый день") и маппить первый говорящий к оператору — планируемое улучшение.

> Примечание: на момент обновления совместимая версия — `vosk==0.3.44`. Если установка падает, удалите строку или создайте отдельный requirements-extra. Для отключения кластеризации спикеров установите `SPEAKER_CLUSTERING=0` в `.env`.

Пример `.env`:
```
SECRET_KEY=...
GEMINI_API_KEY=...
VOSK_MODEL_PATH=/Users/you/models/vosk-model-small-ru-0.22
```

## Улучшения (предложения)
- Точная диаризация (pyannote.audio)
- Whisper/Vosk backend для надёжной сегментации
- Celery/RQ фоновые задачи для тяжёлых файлов
- Dockerfile + compose
- .env.example
- Автотесты (pytest) для анализа и транскриптора
- Логирование (structlog или logging + JSON)

## Генерация отчёта
При скачивании отчёт конвертирует JSON сегменты в удобный текст:
```
[000.00–003.42] Клиент: Здравствуйте...
[003.42–006.10] Оператор: Добрый день...
```

## Лицензия
(Добавьте при необходимости)

---
Если нужны интеграции с Whisper/Vosk или спикер-диаризация — могу помочь с последующими шагами.

{% extends "base.html" %}

{% block title %}Загрузка файлов - OperaMind{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <!-- Hero Section -->
    <div class="card" style="text-align: center; margin-bottom: var(--space-8);">
        <div class="card-header">
            <h1 class="card-title">
                <i class="fas fa-microphone-alt" style="color: var(--primary);"></i>
                Анализ разговоров
            </h1>
            <p class="card-subtitle">
                Загрузите аудиофайл или готовую транскрипцию для автоматического анализа
            </p>
        </div>
        
        <!-- Upload Form -->
        <form id="uploadForm" method="POST" action="{{ url_for('upload_file') }}" enctype="multipart/form-data">
            <div style="margin-bottom: var(--space-6);">
                <label style="display: block; margin-bottom: var(--space-4); font-weight: 600; color: var(--gray-700); text-align: left;">
                    <i class="fas fa-file-upload"></i>
                    Выберите файл
                </label>
                <div class="file-upload-area" style="position: relative; border: 3px dashed var(--primary); border-radius: var(--radius-lg); padding: var(--space-10); background: linear-gradient(135deg, var(--primary-light) 0%, rgba(118, 75, 162, 0.05) 100%); transition: var(--transition); cursor: pointer;">
                    <input type="file" name="file" accept=".mp3,.wav,.m4a,.ogg,.txt" required
                           style="position: absolute; inset: 0; opacity: 0; cursor: pointer;"
                           onchange="updateFileDisplay(this)">
                    <div class="file-upload-content">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary); margin-bottom: var(--space-4);"></i>
                        <p style="font-size: var(--font-size-lg); font-weight: 600; color: var(--gray-700); margin-bottom: var(--space-2);">
                            Перетащите файл сюда или нажмите для выбора
                        </p>
                        <p id="fileName" style="color: var(--primary); font-weight: 500;">
                            Файл не выбран
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- File Types Info -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-8);">
                <div style="background: linear-gradient(135deg, var(--success) 10%, transparent 100%); padding: var(--space-4); border-radius: var(--radius-md); border-left: 4px solid var(--success);">
                    <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                        <i class="fas fa-music" style="color: var(--success);"></i>
                        <strong style="color: var(--gray-800);">Аудиофайлы</strong>
                    </div>
                    <p style="color: var(--gray-600); font-size: var(--font-size-sm);">
                        MP3, WAV, M4A, OGG<br>
                        <small>до 50 МБ</small>
                    </p>
                </div>
                
                <div style="background: linear-gradient(135deg, var(--info) 10%, transparent 100%); padding: var(--space-4); border-radius: var(--radius-md); border-left: 4px solid var(--info);">
                    <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                        <i class="fas fa-file-alt" style="color: var(--info);"></i>
                        <strong style="color: var(--gray-800);">Текстовые файлы</strong>
                    </div>
                    <p style="color: var(--gray-600); font-size: var(--font-size-sm);">
                        TXT файлы<br>
                        <small>готовая транскрипция</small>
                    </p>
                </div>
            </div>
            
            <div style="display: flex; gap: var(--space-4); justify-content: center;">
                <button id="submitBtn" type="submit" class="btn btn-lg" style="min-width: 200px;">
                    <i class="fas fa-rocket"></i>
                    Обработать файл
                </button>
                
                <a href="{{ url_for('history') }}" class="btn btn-outline btn-lg">
                    <i class="fas fa-history"></i>
                    История
                </a>
            </div>
        </form>
    </div>
    
    <!-- Process Steps -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title" style="font-size: var(--font-size-xl);">
                <i class="fas fa-cogs"></i>
                Процесс обработки
            </h3>
        </div>
        
        <div style="display: grid; gap: var(--space-6);">
            <div style="display: flex; gap: var(--space-4); align-items: start;">
                <div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: var(--white); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; box-shadow: var(--shadow);">1</div>
                <div>
                    <h4 style="color: var(--gray-800); font-size: var(--font-size-lg); margin-bottom: var(--space-2);">
                        <i class="fas fa-upload" style="color: var(--primary);"></i>
                        Загрузка файла
                    </h4>
                    <p style="color: var(--gray-600);">Аудио или текстовый файл безопасно сохраняется в системе</p>
                </div>
            </div>
            
            <div style="display: flex; gap: var(--space-4); align-items: start;">
                <div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: var(--white); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; box-shadow: var(--shadow);">2</div>
                <div>
                    <h4 style="color: var(--gray-800); font-size: var(--font-size-lg); margin-bottom: var(--space-2);">
                        <i class="fas fa-microphone" style="color: var(--accent);"></i>
                        Транскрипция
                    </h4>
                    <p style="color: var(--gray-600);">Аудио преобразуется в текст с помощью продвинутых алгоритмов распознавания речи</p>
                </div>
            </div>
            
            <div style="display: flex; gap: var(--space-4); align-items: start;">
                <div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: var(--white); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; box-shadow: var(--shadow);">3</div>
                <div>
                    <h4 style="color: var(--gray-800); font-size: var(--font-size-lg); margin-bottom: var(--space-2);">
                        <i class="fas fa-brain" style="color: var(--warning);"></i>
                        ИИ-анализ
                    </h4>
                    <p style="color: var(--gray-600);">Gemini AI анализирует содержание: тема, тональность, ключевые моменты</p>
                </div>
            </div>
            
            <div style="display: flex; gap: var(--space-4); align-items: start;">
                <div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: var(--white); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; box-shadow: var(--shadow);">4</div>
                <div>
                    <h4 style="color: var(--gray-800); font-size: var(--font-size-lg); margin-bottom: var(--space-2);">
                        <i class="fas fa-chart-line" style="color: var(--success);"></i>
                        Формирование отчёта
                    </h4>
                    <p style="color: var(--gray-600);">Создание детального анализа с рекомендациями для улучшения работы</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Overlay -->
<div id="progressOverlay" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--white); padding: var(--space-10); border-radius: var(--radius-xl); width: 480px; box-shadow: var(--shadow-xl); text-align: center;">
        <h2 style="margin-bottom: var(--space-4); font-size: var(--font-size-2xl); color: var(--gray-900);">
            <i class="fas fa-spinner fa-spin" style="color: var(--primary);"></i>
            Обработка файла
        </h2>
        <p id="phaseText" style="color: var(--gray-600); margin-bottom: var(--space-6); font-size: var(--font-size-lg);">
            Загрузка файла...
        </p>
        
        <div class="progress-bar" style="margin-bottom: var(--space-6);">
            <div id="progressFill" class="progress-fill" style="width: 10%;"></div>
        </div>
        
        <p style="font-size: var(--font-size-sm); color: var(--gray-500);">
            <i class="fas fa-info-circle"></i>
            Не закрывайте страницу до завершения обработки
        </p>
    </div>
</div>

<script>
    // File upload interactions
    function updateFileDisplay(input) {
        const fileName = document.getElementById('fileName');
        const uploadArea = document.querySelector('.file-upload-area');
        
        if (input.files && input.files[0]) {
            fileName.textContent = input.files[0].name;
            fileName.style.color = 'var(--success)';
            uploadArea.style.borderColor = 'var(--success)';
            uploadArea.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%)';
        } else {
            fileName.textContent = 'Файл не выбран';
            fileName.style.color = 'var(--primary)';
            uploadArea.style.borderColor = 'var(--primary)';
            uploadArea.style.background = 'linear-gradient(135deg, var(--primary-light) 0%, rgba(118, 75, 162, 0.05) 100%)';
        }
    }
    
    // Drag and drop functionality
    const uploadArea = document.querySelector('.file-upload-area');
    const fileInput = document.querySelector('input[type="file"]');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
    });
    
    uploadArea.addEventListener('drop', handleDrop, false);
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    function highlight(e) {
        uploadArea.style.borderColor = 'var(--success)';
        uploadArea.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.1) 100%)';
    }
    
    function unhighlight(e) {
        uploadArea.style.borderColor = 'var(--primary)';
        uploadArea.style.background = 'linear-gradient(135deg, var(--primary-light) 0%, rgba(118, 75, 162, 0.05) 100%)';
    }
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        fileInput.files = files;
        updateFileDisplay(fileInput);
    }
    
    // Form submission with progress
    const form = document.getElementById('uploadForm');
    const overlay = document.getElementById('progressOverlay');
    const progressFill = document.getElementById('progressFill');
    const phaseText = document.getElementById('phaseText');
    const submitBtn = document.getElementById('submitBtn');
    
    if (form) {
        form.addEventListener('submit', () => {
            overlay.style.display = 'flex';
            submitBtn.disabled = true;
            
            let progress = 10;
            phaseText.textContent = 'Загрузка файла...';
            progressFill.style.width = progress + '%';
            
            const phases = [
                { delay: 1500, text: 'Транскрипция аудио...', progress: 35 },
                { delay: 4000, text: 'ИИ-анализ содержания...', progress: 65 },
                { delay: 7000, text: 'Формирование отчёта...', progress: 85 },
                { delay: 9000, text: 'Завершение обработки...', progress: 95 }
            ];
            
            phases.forEach(phase => {
                setTimeout(() => {
                    phaseText.textContent = phase.text;
                    progressFill.style.width = phase.progress + '%';
                }, phase.delay);
            });
        });
    }
</script>
{% endblock %}
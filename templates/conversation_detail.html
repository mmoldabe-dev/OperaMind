{% extends "base.html" %}

{% block title %}{{ conversation.filename }} - OperaMind{% endblock %}

{% block content %}
<style>
.content-wrapper {
    max-width: 1000px;
    margin: 0 auto;
}

.detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
    gap: var(--space-4);
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
}

.info-card {
    background: linear-gradient(135deg, var(--gray-50) 0%, var(--white) 100%);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: var(--space-3);
    transition: var(--transition);
}

.info-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.info-icon {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: var(--white);
    box-shadow: var(--shadow);
}

.info-content {
    width: 100%;
}

.info-content .label {
    font-size: var(--font-size-xs);
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: var(--space-1);
}

.info-content .value {
    font-size: var(--font-size-lg);
    font-weight: 700;
    color: var(--gray-800);
}

.analysis-section {
    background: var(--white);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    margin-bottom: var(--space-6);
    border-left: 4px solid var(--primary);
    box-shadow: var(--shadow);
}

.section-title {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
    font-size: var(--font-size-xl);
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: var(--space-4);
}

.section-title i {
    color: var(--primary);
}

.keyword-tag {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: var(--white);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-sm);
    font-weight: 600;
    box-shadow: var(--shadow-sm);
}

.keywords-wrapper {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    justify-content: center;
}

.chat-container {
    background: var(--gray-50);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    max-height: 700px;
    overflow-y: auto;
}

.chat-message {
    display: flex;
    gap: var(--space-4);
    margin-bottom: var(--space-5);
    max-width: 85%;
}

.chat-message.operator {
    flex-direction: row-reverse;
    margin-left: auto;
}

.chat-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    box-shadow: var(--shadow);
    flex-shrink: 0;
}

.avatar-client {
    background: linear-gradient(135deg, var(--info), #1e40af);
    color: var(--white);
}

.avatar-operator {
    background: linear-gradient(135deg, var(--success), #059669);
    color: var(--white);
}

.chat-bubble {
    flex: 1;
}

.bubble-header {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
}

.operator .bubble-header {
    justify-content: flex-end;
}

.bubble-name {
    font-weight: 700;
    font-size: var(--font-size-sm);
    color: var(--gray-800);
}

.bubble-time {
    font-size: var(--font-size-xs);
    color: var(--gray-500);
}

.bubble-content {
    background: var(--white);
    padding: var(--space-4);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    line-height: 1.6;
    color: var(--gray-800);
}

.operator .bubble-content {
    background: linear-gradient(135deg, var(--success), #059669);
    color: var(--white);
}

.word-chips {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-1);
    margin-top: var(--space-3);
    padding-top: var(--space-3);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.word-chip {
    background: rgba(255, 255, 255, 0.25);
    padding: 2px var(--space-2);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    cursor: help;
    transition: var(--transition);
}

.word-chip:hover {
    background: rgba(255, 255, 255, 0.4);
}

.operator .word-chip {
    background: rgba(255, 255, 255, 0.2);
}

.operator .word-chip:hover {
    background: rgba(255, 255, 255, 0.35);
}

.silence-indicator {
    display: flex;
    justify-content: center;
    margin: var(--space-4) 0;
}

.silence-badge {
    background: var(--gray-200);
    color: var(--gray-600);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-sm);
    font-style: italic;
}

.empty-state {
    text-align: center;
    padding: var(--space-12);
    color: var(--gray-500);
}

.empty-state i {
    font-size: 4rem;
    color: var(--gray-300);
    margin-bottom: var(--space-6);
}
</style>

<div class="content-wrapper">
    <div class="detail-header">
        <a href="{{ url_for('history') }}" class="btn btn-outline">
            <i class="fas fa-arrow-left"></i>
            Назад к истории
        </a>
        
        <div style="display: flex; gap: var(--space-3);">
            {% if conversation.analysis %}
            <a href="{{ url_for('download_report', conversation_id=conversation.id) }}" class="btn btn-success">
                <i class="fas fa-download"></i>
                Скачать отчёт
            </a>
            {% endif %}
            <form method="POST" action="{{ url_for('delete_conversation', conversation_id=conversation.id) }}" onsubmit="return confirm('Удалить этот разговор?');" style="display: inline;">
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-trash"></i>
                    Удалить
                </button>
            </form>
        </div>
    </div>

    <div class="card" style="margin-bottom: var(--space-6); text-align: center;">
        <div class="card-header">
            <h1 class="card-title" style="display: flex; align-items: center; justify-content: center; gap: var(--space-3);">
                <i class="fas fa-phone-volume" style="color: var(--primary);"></i>
                {{ conversation.filename }}
            </h1>
            <div style="display: flex; gap: var(--space-6); margin-top: var(--space-3); flex-wrap: wrap; justify-content: center;">
                <div style="display: flex; align-items: center; gap: var(--space-2); color: var(--gray-600);">
                    <i class="fas fa-calendar"></i>
                    <span>{{ conversation.upload_date.strftime('%d.%m.%Y в %H:%M') }}</span>
                </div>
                <div style="display: flex; align-items: center; gap: var(--space-2); color: var(--gray-600);">
                    <i class="fas fa-user"></i>
                    <span>{{ conversation.user.username }}</span>
                </div>
                <div>
                    {% if conversation.status == 'completed' %}
                    <span style="background: var(--success); color: var(--white); padding: var(--space-2) var(--space-4); border-radius: var(--radius-lg); font-weight: 600; font-size: var(--font-size-sm);">
                        <i class="fas fa-check-circle"></i> Завершено
                    </span>
                    {% elif conversation.status == 'transcribing' %}
                    <span style="background: var(--info); color: var(--white); padding: var(--space-2) var(--space-4); border-radius: var(--radius-lg); font-weight: 600; font-size: var(--font-size-sm);">
                        <i class="fas fa-microphone"></i> Транскрипция
                    </span>
                    {% elif conversation.status == 'analyzing' %}
                    <span style="background: var(--warning); color: var(--white); padding: var(--space-2) var(--space-4); border-radius: var(--radius-lg); font-weight: 600; font-size: var(--font-size-sm);">
                        <i class="fas fa-brain"></i> Анализ
                    </span>
                    {% elif conversation.status == 'error' %}
                    <span style="background: var(--error); color: var(--white); padding: var(--space-2) var(--space-4); border-radius: var(--radius-lg); font-weight: 600; font-size: var(--font-size-sm);">
                        <i class="fas fa-exclamation-circle"></i> Ошибка
                    </span>
                    {% else %}
                    <span style="background: var(--gray-500); color: var(--white); padding: var(--space-2) var(--space-4); border-radius: var(--radius-lg); font-weight: 600; font-size: var(--font-size-sm);">
                        <i class="fas fa-clock"></i> Ожидает
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if conversation.analysis %}
    <div class="info-grid">
        <div class="info-card">
            <div class="info-icon">
                <i class="fas fa-comment-dots"></i>
            </div>
            <div class="info-content">
                <div class="label">Тема разговора</div>
                <div class="value">{{ conversation.analysis.topic or 'Не определена' }}</div>
            </div>
        </div>
        
        <div class="info-card">
            <div class="info-icon" style="background: linear-gradient(135deg, var(--accent), #14b8a6);">
                <i class="fas fa-tags"></i>
            </div>
            <div class="info-content">
                <div class="label">Категория</div>
                <div class="value">{{ conversation.analysis.category or 'Не определена' }}</div>
            </div>
        </div>
        
        <div class="info-card">
            {% if conversation.analysis.sentiment == 'позитивный' %}
            <div class="info-icon" style="background: linear-gradient(135deg, var(--success), #059669);">
            {% elif conversation.analysis.sentiment == 'негативный' %}
            <div class="info-icon" style="background: linear-gradient(135deg, var(--error), #dc2626);">
            {% else %}
            <div class="info-icon" style="background: linear-gradient(135deg, var(--info), #1e40af);">
            {% endif %}
                <i class="fas fa-smile"></i>
            </div>
            <div class="info-content">
                <div class="label">Тональность</div>
                <div class="value">{{ conversation.analysis.sentiment or 'Не определена' }}</div>
            </div>
        </div>
        
        <div class="info-card">
            {% if conversation.analysis.urgency == 'критическая' %}
            <div class="info-icon" style="background: linear-gradient(135deg, var(--error), #dc2626);">
            {% elif conversation.analysis.urgency == 'высокая' %}
            <div class="info-icon" style="background: linear-gradient(135deg, var(--warning), #d97706);">
            {% elif conversation.analysis.urgency == 'средняя' %}
            <div class="info-icon" style="background: linear-gradient(135deg, var(--info), #1e40af);">
            {% else %}
            <div class="info-icon" style="background: linear-gradient(135deg, var(--success), #059669);">
            {% endif %}
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="info-content">
                <div class="label">Срочность</div>
                <div class="value">{{ conversation.analysis.urgency or 'Не определена' }}</div>
            </div>
        </div>
    </div>

    {% if conversation.analysis.operator_quality %}
    <div class="analysis-section" style="border-left-color: var(--warning); text-align: center;">
        <h3 class="section-title">
            <i class="fas fa-star" style="color: var(--warning);"></i>
            Качество работы оператора
        </h3>
        <div style="font-size: var(--font-size-3xl); font-weight: 700; color: var(--warning);">
            {{ conversation.analysis.operator_quality }}
        </div>
    </div>
    {% endif %}

    <div class="analysis-section" style="border-left-color: var(--info);">
        <h3 class="section-title">
            <i class="fas fa-file-alt" style="color: var(--info);"></i>
            Краткое содержание
        </h3>
        <p style="line-height: 1.8; color: var(--gray-700); font-size: var(--font-size-base);">
            {{ conversation.analysis.summary or 'Краткое содержание недоступно' }}
        </p>
    </div>

    {% if conversation.analysis.detailed_analysis %}
    <div class="analysis-section">
        <h3 class="section-title">
            <i class="fas fa-search"></i>
            Подробный анализ
        </h3>
        <p style="line-height: 1.8; color: var(--gray-700); white-space: pre-line; font-size: var(--font-size-base);">
            {{ conversation.analysis.detailed_analysis }}
        </p>
    </div>
    {% endif %}

    {% if conversation.analysis.recommendations %}
    <div class="analysis-section" style="border-left-color: var(--success);">
        <h3 class="section-title">
            <i class="fas fa-lightbulb" style="color: var(--success);"></i>
            Рекомендации для улучшения
        </h3>
        <p style="line-height: 1.8; color: var(--gray-700); white-space: pre-line; font-size: var(--font-size-base);">
            {{ conversation.analysis.recommendations }}
        </p>
    </div>
    {% endif %}

    {% if conversation.analysis.keywords %}
    <div class="analysis-section" style="border-left-color: var(--secondary);">
        <h3 class="section-title">
            <i class="fas fa-key" style="color: var(--secondary);"></i>
            Ключевые слова
        </h3>
        <div class="keywords-wrapper">
            {% set keywords = conversation.analysis.keywords|from_json %}
            {% for keyword in keywords %}
            <span class="keyword-tag">
                <i class="fas fa-tag"></i>
                {{ keyword }}
            </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header">
            <h3 class="card-title" style="display: flex; align-items: center; justify-content: center; gap: var(--space-3);">
                <i class="fas fa-comments" style="color: var(--accent);"></i>
                Полная транскрипция
            </h3>
        </div>
        
        {% if conversation.analysis.transcript %}
            {% if conversation.analysis.transcript.startswith('{') %}
                {% set structured = conversation.analysis.transcript|from_json %}
                {% if structured and structured.segments %}
        
        <div style="display: flex; gap: var(--space-3); flex-wrap: wrap; margin-bottom: var(--space-6); justify-content: center;">
            <div style="background: var(--primary-light); padding: var(--space-2) var(--space-4); border-radius: var(--radius); font-size: var(--font-size-sm); color: var(--primary); font-weight: 600;">
                <i class="fas fa-cog"></i>
                {{ structured.meta.method if structured.meta and structured.meta.method else 'Неизвестно' }}
            </div>
            <div style="background: var(--gray-100); padding: var(--space-2) var(--space-4); border-radius: var(--radius); font-size: var(--font-size-sm); color: var(--gray-600); font-weight: 600;">
                <i class="fas fa-clock"></i>
                Длительность: {{ structured.meta.duration_sec }}с
            </div>
        </div>
        
        <div class="chat-container">
            {% for seg in structured.segments %}
                {% if seg.segment_type is defined and seg.segment_type == 'silence' %}
                    <div class="silence-indicator">
                        <div class="silence-badge">
                            <i class="fas fa-pause"></i>
                            {{ seg.text }}
                        </div>
                    </div>
                {% else %}
                    <div class="chat-message {% if seg.speaker == 'operator' %}operator{% endif %}">
                        <div class="chat-avatar {% if seg.speaker == 'client' %}avatar-client{% elif seg.speaker == 'operator' %}avatar-operator{% endif %}">
                            {% if seg.speaker == 'client' %}
                            <i class="fas fa-user"></i>
                            {% elif seg.speaker == 'operator' %}
                            <i class="fas fa-headset"></i>
                            {% else %}
                            <i class="fas fa-question"></i>
                            {% endif %}
                        </div>
                        
                        <div class="chat-bubble">
                            <div class="bubble-header">
                                <span class="bubble-name">
                                    {% if seg.speaker == 'client' %}Клиент{% elif seg.speaker == 'operator' %}Оператор{% else %}Неизвестно{% endif %}
                                </span>
                                <span class="bubble-time">
                                    <i class="fas fa-clock"></i>
                                    {{ seg.start }}—{{ seg.end }}с
                                </span>
                            </div>
                            
                            <div class="bubble-content">
                                <div>{{ seg.text }}</div>
                                
                                {% if seg.words %}
                                <div class="word-chips">
                                    {% for w in seg.words %}
                                    <span class="word-chip" title="Время: {{ w.start }}—{{ w.end }}с">
                                        {{ w.w }}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
                {% else %}
        <div style="background: var(--gray-50); padding: var(--space-6); border-radius: var(--radius-lg); line-height: 1.8; color: var(--gray-700); white-space: pre-line;">
            {{ conversation.analysis.transcript }}
        </div>
                {% endif %}
            {% else %}
        <div style="background: var(--gray-50); padding: var(--space-6); border-radius: var(--radius-lg); line-height: 1.8; color: var(--gray-700); white-space: pre-line;">
            {{ conversation.analysis.transcript }}
        </div>
            {% endif %}
        {% else %}
        <div class="empty-state">
            <i class="fas fa-file-alt"></i>
            <p>Транскрипция недоступна</p>
        </div>
        {% endif %}
    </div>

    {% else %}
    <div class="card empty-state">
        <i class="fas fa-hourglass-half"></i>
        <h3 style="color: var(--gray-700); margin-bottom: var(--space-3);">Анализ в процессе</h3>
        <p>Обработка файла может занять некоторое время.<br>Страница автоматически обновится при завершении.</p>
        <div style="margin-top: var(--space-6);">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <script>
    if ('{{ conversation.status }}' !== 'completed') {
        setTimeout(function() {
            window.location.reload();
        }, 10000);
    }
    </script>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatContainer = document.querySelector('.chat-container');
    if (chatContainer) {
        chatContainer.scrollTop = 0;
    }
});
</script>
{% endblock %}
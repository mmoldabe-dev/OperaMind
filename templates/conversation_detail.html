{% extends "base.html" %}

{% block title %}{{ conversation.filename }} - OperaMind{% endblock %}

{% block content %}
<div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
    <a href="{{ url_for('history') }}" style="color: #667eea; text-decoration: none; font-weight: 500;">
        ‚Üê –ù–∞–∑–∞–¥ –∫ –∏—Å—Ç–æ—Ä–∏–∏
    </a>
    
    {% if conversation.analysis %}
    <a href="{{ url_for('download_report', conversation_id=conversation.id) }}" class="btn" style="background: #27ae60;">
        üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç
    </a>
    {% endif %}
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 25px;">
        <div>
            <h2 style="color: #2c3e50; margin-bottom: 10px;">üìû {{ conversation.filename }}</h2>
            <p style="color: #7f8c8d;">
                –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {{ conversation.upload_date.strftime('%d.%m.%Y –≤ %H:%M') }}
            </p>
            <p style="margin-top: 10px;">
                –°—Ç–∞—Ç—É—Å: 
                {% if conversation.status == 'completed' %}
                    <span style="background: #27ae60; color: white; padding: 4px 12px; border-radius: 12px;">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                {% elif conversation.status == 'transcribing' %}
                    <span style="background: #3498db; color: white; padding: 4px 12px; border-radius: 12px;">üéß –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è...</span>
                {% elif conversation.status == 'analyzing' %}
                    <span style="background: #f39c12; color: white; padding: 4px 12px; border-radius: 12px;">ü§ñ –ê–Ω–∞–ª–∏–∑...</span>
                {% elif conversation.status == 'error' %}
                    <span style="background: #e74c3c; color: white; padding: 4px 12px; border-radius: 12px;">‚ùå –û—à–∏–±–∫–∞</span>
                {% else %}
                    <span style="background: #95a5a6; color: white; padding: 4px 12px; border-radius: 12px;">‚è≥ –û–∂–∏–¥–∞–µ—Ç</span>
                {% endif %}
            </p>
        </div>
        <form method="POST" action="{{ url_for('delete_conversation', conversation_id=conversation.id) }}" 
              onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä?');">
            <button type="submit" class="btn btn-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        </form>
    </div>

    {% if conversation.analysis %}
    <!-- –û–°–ù–û–í–ù–´–ï –ú–ï–¢–†–ò–ö–ò -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
        <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 20px; border-radius: 10px;">
            <p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 5px;">–¢–ï–ú–ê</p>
            <p style="color: #2c3e50; font-weight: 600; font-size: 1.1rem;">{{ conversation.analysis.topic }}</p>
        </div>

        <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 20px; border-radius: 10px;">
            <p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 5px;">–ö–ê–¢–ï–ì–û–†–ò–Ø</p>
            <p style="color: #2c3e50; font-weight: 600; font-size: 1.1rem;">{{ conversation.analysis.category }}</p>
        </div>

        <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 20px; border-radius: 10px;">
            <p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 5px;">–¢–û–ù–ê–õ–¨–ù–û–°–¢–¨</p>
            {% if conversation.analysis.sentiment == '–ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π' %}
                <p style="font-weight: 600; font-size: 1.1rem; color: #27ae60;">{{ conversation.analysis.sentiment }}</p>
            {% elif conversation.analysis.sentiment == '–Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π' %}
                <p style="font-weight: 600; font-size: 1.1rem; color: #e74c3c;">{{ conversation.analysis.sentiment }}</p>
            {% else %}
                <p style="font-weight: 600; font-size: 1.1rem; color: #f39c12;">{{ conversation.analysis.sentiment }}</p>
            {% endif %}
        </div>

        <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 20px; border-radius: 10px;">
            <p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 5px;">–°–†–û–ß–ù–û–°–¢–¨</p>
            {% if conversation.analysis.urgency == '–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è' %}
                <p style="font-weight: 600; font-size: 1.1rem; color: #e74c3c;">{{ conversation.analysis.urgency }}</p>
            {% elif conversation.analysis.urgency == '–≤—ã—Å–æ–∫–∞—è' %}
                <p style="font-weight: 600; font-size: 1.1rem; color: #f39c12;">{{ conversation.analysis.urgency }}</p>
            {% elif conversation.analysis.urgency == '—Å—Ä–µ–¥–Ω—è—è' %}
                <p style="font-weight: 600; font-size: 1.1rem; color: #3498db;">{{ conversation.analysis.urgency }}</p>
            {% else %}
                <p style="font-weight: 600; font-size: 1.1rem; color: #95a5a6;">{{ conversation.analysis.urgency }}</p>
            {% endif %}
        </div>
    </div>

    <!-- –ö–ê–ß–ï–°–¢–í–û –û–ü–ï–†–ê–¢–û–†–ê -->
    {% if conversation.analysis.operator_quality %}
    <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #667eea;">
        <h3 style="color: #2c3e50; margin-bottom: 10px;">‚≠ê –ö–∞—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</h3>
        <p style="font-size: 1.2rem; font-weight: 600; color: #667eea;">{{ conversation.analysis.operator_quality }}</p>
    </div>
    {% endif %}

    <!-- –ö–†–ê–¢–ö–û–ï –°–û–î–ï–†–ñ–ê–ù–ò–ï -->
    <div style="background: #f8f9ff; padding: 25px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #667eea;">
        <h3 style="color: #2c3e50; margin-bottom: 15px;">üìù –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</h3>
        <p style="color: #555; line-height: 1.8;">{{ conversation.analysis.summary }}</p>
    </div>

    <!-- –ü–û–î–†–û–ë–ù–´–ô –ê–ù–ê–õ–ò–ó -->
    {% if conversation.analysis.detailed_analysis %}
    <div style="background: #fff3cd; padding: 25px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #ffc107;">
        <h3 style="color: #2c3e50; margin-bottom: 15px;">üîç –ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h3>
        <p style="color: #555; line-height: 1.8; white-space: pre-line;">{{ conversation.analysis.detailed_analysis }}</p>
    </div>
    {% endif %}

    <!-- –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò -->
    {% if conversation.analysis.recommendations %}
    <div style="background: #d4edda; padding: 25px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #28a745;">
        <h3 style="color: #2c3e50; margin-bottom: 15px;">üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
        <p style="color: #555; line-height: 1.8; white-space: pre-line;">{{ conversation.analysis.recommendations }}</p>
    </div>
    {% endif %}

    <!-- –ö–õ–Æ–ß–ï–í–´–ï –°–õ–û–í–ê -->
    <div style="margin-bottom: 25px;">
        <h3 style="color: #2c3e50; margin-bottom: 15px;">üîë –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
            {% if conversation.analysis.keywords %}
                {% set keywords = conversation.analysis.keywords|from_json %}
                {% for keyword in keywords %}
                <span style="background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 500;">
                    {{ keyword }}
                </span>
                {% endfor %}
            {% endif %}
        </div>
    </div>

    <!-- –ü–û–õ–ù–ê–Ø –¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø (–°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–ù–ê–Ø) -->
    <div style="background: #f8f9fa; padding: 25px; border-radius: 10px;">
        <h3 style="color: #2c3e50; margin-bottom: 15px;">ÔøΩ –ü–æ–ª–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (–î–∏–∞–ª–æ–≥)</h3>
        {% set is_json = False %}
        {% set structured = None %}
        {% if conversation.analysis.transcript %}
            {% set raw = conversation.analysis.transcript %}
            {% if raw.startswith('{') %}
                {% set is_json = True %}
                {% set structured = raw|from_json %}
            {% endif %}
        {% endif %}
        {% if is_json and structured and structured.segments %}
        <div style="display:flex; gap:20px; flex-wrap:wrap; margin-bottom:15px;">
            <div style="background:#eef2ff;padding:8px 14px;border-radius:20px;font-size:0.85rem;">–ú–µ—Ç–æ–¥: {{ structured.meta.method if structured.meta and structured.meta.method }}</div>
            <div style="background:#eef2ff;padding:8px 14px;border-radius:20px;font-size:0.85rem;">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {{ structured.meta.duration_sec }} c</div>
        </div>
        <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:10px; font-size:0.65rem;">
            <span style="background:#6366f1;color:white;padding:4px 10px;border-radius:14px;">CL –ö–ª–∏–µ–Ω—Ç</span>
            <span style="background:#10b981;color:white;padding:4px 10px;border-radius:14px;">OP –û–ø–µ—Ä–∞—Ç–æ—Ä</span>
            <span style="background:#fde68a;color:#92400e;padding:4px 10px;border-radius:14px;">–ü–∞—É–∑–∞ &gt; 0.4 c</span>
            <span style="background:#eef2ff;color:#4338ca;padding:4px 10px;border-radius:14px;">–°–ª–æ–≤–∞ —Å —Ç–∞–π–º–∫–æ–¥–∞–º–∏</span>
        </div>
        <style>
            #chat .seg.silence { opacity:0.75; }
            #chat .seg.silence .bubble { background:#fffdf5; border-color:#f7e7c2; font-style:italic; }
            #chat .seg.silence .bubble:before { content:'‚è∏Ô∏è'; margin-right:6px; }
        </style>
        <div id="chat" style="background: white; padding: 20px; border-radius: 8px; max-height: 600px; overflow-y: auto; color:#2c3e50;">
            {% for seg in structured.segments %}
                {% set seg_type = seg.segment_type if 'segment_type' in seg else ('speech') %}
                <div class="seg {% if seg_type=='silence' %}silence{% endif %}" style="margin-bottom:18px; display:flex; gap:14px; align-items:flex-start;">
                    <div style="width:52px;text-align:center;">
                        {% if seg.speaker == 'client' %}
                            <div style="background:#6366f1;color:white;width:42px;height:42px;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:0.75rem;">CL</div>
                        {% elif seg.speaker == 'operator' %}
                            <div style="background:#10b981;color:white;width:42px;height:42px;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:0.75rem;">OP</div>
                        {% else %}
                            <div style="background:#9ca3af;color:white;width:42px;height:42px;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:0.75rem;">UK</div>
                        {% endif %}
                        <div style="margin-top:6px;font-size:0.65rem;color:#6b7280;">{{ seg.start }}s</div>
                    </div>
                    <div style="flex:1;">
                        <div style="display:flex;align-items:center;gap:10px; margin-bottom:6px;">
                            <strong style="font-size:0.9rem;">
                                {% if seg.speaker == 'client' %}–ö–ª–∏–µ–Ω—Ç{% elif seg.speaker == 'operator' %}–û–ø–µ—Ä–∞—Ç–æ—Ä{% else %}–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ{% endif %}
                            </strong>
                            <span style="background:#f3f4f6;padding:2px 8px;border-radius:12px;font-size:0.65rem;color:#374151;">{{ seg.start }} ‚Äì {{ seg.end }} c</span>
                            {% if seg.gap_from_prev and seg.gap_from_prev > 0.4 %}
                                <span style="background:#fde68a;padding:2px 6px;border-radius:12px;font-size:0.6rem;color:#92400e;">–ü–∞—É–∑–∞ {{ seg.gap_from_prev }} c</span>
                            {% endif %}
                        </div>
                        <div class="bubble" style="background:#f9fafb;border:1px solid #e5e7eb;padding:12px 14px;border-radius:10px;line-height:1.6;font-size:0.9rem; position:relative;">
                            <div style="margin-bottom:8px; white-space:pre-wrap;">
                                {% if seg_type=='silence' %}<em>{{ seg.text }}</em>{% else %}{{ seg.text }}{% endif %}
                            </div>
                            {% if seg.words %}
                                <div style="display:flex; flex-wrap:wrap; gap:4px; margin-top:6px;">
                                    {% for w in seg.words %}
                                        <span class="word" data-start="{{ w.start }}" data-end="{{ w.end }}" title="{{ w.start }}‚Äì{{ w.end }} c" style="background:#eef2ff;color:#4338ca;padding:3px 6px;border-radius:6px;font-size:0.6rem; cursor:help; transition:background .3s;">{{ w.w }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <script>
            // Hover –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤
            document.querySelectorAll('#chat .seg').forEach(seg => {
                seg.addEventListener('mouseenter', () => {
                    const bubble = seg.querySelector('.bubble');
                    if (bubble) bubble.style.boxShadow = '0 0 0 2px #667eea55, 0 4px 14px rgba(0,0,0,0.08)';
                });
                seg.addEventListener('mouseleave', () => {
                    const bubble = seg.querySelector('.bubble');
                    if (bubble) bubble.style.boxShadow = 'none';
                });
            });
            // –ê–Ω–∏–º–∞—Ü–∏—è —Å–ª–æ–≤ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
            document.querySelectorAll('#chat .word').forEach(w => {
                w.addEventListener('mouseenter', () => {
                    w.style.background = '#c7d2fe';
                });
                w.addEventListener('mouseleave', () => {
                    w.style.background = '#eef2ff';
                });
            });
        </script>
        {% else %}
            <div style="background: white; padding: 20px; border-radius: 8px; max-height: 500px; overflow-y: auto; line-height: 1.8; color: #2c3e50; white-space: pre-line;">{{ conversation.analysis.transcript }}</div>
        {% endif %}
    </div>

    {% else %}
    <!-- –ù–ï–¢ –ê–ù–ê–õ–ò–ó–ê -->
    <div style="text-align: center; padding: 60px 20px; color: #7f8c8d;">
        <p style="font-size: 3rem; margin-bottom: 20px;">‚è≥</p>
        <h3 style="color: #2c3e50; margin-bottom: 10px;">–ê–Ω–∞–ª–∏–∑ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ</h3>
        <p>–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è</p>
    </div>
    {% endif %}
</div>
{% endblock %}
{% extends 'base.html' %}
{% block title %}–ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ - OperaMind{% endblock %}
{% block content %}

<div class="card" style="animation:fadeInUp .4s ease;">
    <div class="card-header" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:var(--space-6);margin-bottom:var(--space-4);">
        <div>
            <h2 class="card-title" style="display:flex;align-items:center;gap:var(--space-3);"><i class="fas fa-headset" style="color:var(--primary);"></i> –ú–æ–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã</h2>
            <div class="card-subtitle">–í—Å–µ –≤–∞—à–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã</div>
        </div>
    </div>

    {% if conversations %}
    {% set total = conversations|length %}
    {% set completed = conversations|selectattr('status','equalto','completed')|list|length %}
    {% set errors = conversations|selectattr('status','equalto','error')|list|length %}
    {% set analyzing = conversations|selectattr('status','equalto','analyzing')|list|length %}
    {% set transcribing = conversations|selectattr('status','equalto','transcribing')|list|length %}
    {% set pending = conversations|selectattr('status','equalto','pending')|list|length %}

    <div class="admin-grid" style="--cols:repeat(auto-fit,minmax(140px,1fr));margin-top:0;">
        <div class="stat-card"><div class="stat-number">{{ total }}</div><div class="stat-label">–í—Å–µ–≥–æ</div></div>
        <div class="stat-card"><div class="stat-number" style="color:var(--success);">{{ completed }}</div><div class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div></div>
        <div class="stat-card"><div class="stat-number" style="color:var(--warning);">{{ analyzing + transcribing + pending }}</div><div class="stat-label">–í —Ä–∞–±–æ—Ç–µ</div></div>
        <div class="stat-card"><div class="stat-number" style="color:var(--error);">{{ errors }}</div><div class="stat-label">–û—à–∏–±–∫–∏</div></div>
    </div>

    <!-- –ú–∏–Ω–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ -->
    {% set weekdays = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'] %}
    {% set calls_by_day = dict.fromkeys(weekdays, 0) %}
    {% for c in conversations %}
        {% set wd = c.upload_date.strftime('%a') %}
        {% set map = {'Mon':'–ü–Ω','Tue':'–í—Ç','Wed':'–°—Ä','Thu':'–ß—Ç','Fri':'–ü—Ç','Sat':'–°–±','Sun':'–í—Å'} %}
        {% set dlabel = map.get(wd, '–ü–Ω') %}
        {% set _ = calls_by_day.update({dlabel: (calls_by_day[dlabel] + 1)}) %}
    {% endfor %}
    {% set max_day = calls_by_day.values()|max %}
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:var(--space-6);margin-top:var(--space-6);">
        <div class="card" style="margin:0;padding:var(--space-6);">
            <h3 style="font-size:var(--font-size-base);margin-bottom:var(--space-4);display:flex;align-items:center;gap:var(--space-2);"><i class="fas fa-calendar-week" style="color:var(--primary);"></i> –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º</h3>
            <div style="display:flex;align-items:flex-end;gap:6px;height:110px;">
                {% for label, val in calls_by_day.items() %}
                    {% set h = ( (val / (max_day if max_day>0 else 1)) * 100 ) %}
                    <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;gap:4px;">
                        <div class="mini-bar" data-h="{{ h|round(0) }}" title="{{ val }} –∑–≤–æ–Ω–∫–æ–≤"></div>
                        <div style="font-size:10px;color:var(--gray-500);">{{ label }}</div>
                    </div>
                {% endfor %}
            </div>
        </div>
        <div class="card" style="margin:0;padding:var(--space-6);">
            <h3 style="font-size:var(--font-size-base);margin-bottom:var(--space-4);display:flex;align-items:center;gap:var(--space-2);"><i class="fas fa-tasks" style="color:var(--accent);"></i> –°—Ç–∞—Ç—É—Å—ã</h3>
            {% set status_counts = {
                'completed': completed,
                'error': errors,
                'working': analyzing + transcribing + pending
            } %}
            {% set total_calc = completed + errors + analyzing + transcribing + pending %}
            <div style="display:flex;flex-direction:column;gap:10px;">
                {% for k,v in status_counts.items() %}
                    {% set perc = ( (v / (total_calc if total_calc>0 else 1)) * 100 ) %}
                    <div style="display:flex;flex-direction:column;gap:4px;">
                        <div style="display:flex;justify-content:space-between;font-size:var(--font-size-xs);color:var(--gray-600);">
                            <span>{{ k }}</span><span>{{ v }}</span>
                        </div>
                        <div class="progress-outer"><div class="progress-inner status-{{ k }}" data-w="{{ perc|round(1) }}"></div></div>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% set all_keywords = [] %}
        {% for c in conversations if c.analysis and c.analysis.keywords %}
            {% set kw = (c.analysis.keywords | from_json) %}
            {% for w in kw %}{% set _ = all_keywords.append(w) %}{% endfor %}
        {% endfor %}
        {% set freq = {} %}
        {% for w in all_keywords %}
            {% set _ = freq.update({ w: (freq.get(w,0)+1) }) %}
        {% endfor %}
        {# –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–ª–æ–≤–∞—Ä—å –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é –∏ –ø–æ—Ç–æ–º –≤–æ–∑—å–º—ë–º –ø–µ—Ä–≤—ã–µ 8 –≤ —Ü–∏–∫–ª–µ #}
        {% set top = freq|dictsort(by='value', reverse=True) %}
        <div class="card" style="margin:0;padding:var(--space-6);">
            <h3 style="font-size:var(--font-size-base);margin-bottom:var(--space-4);display:flex;align-items:center;gap:var(--space-2);"><i class="fas fa-key" style="color:var(--warning);"></i> –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞</h3>
                    {% if top %}
            <div style="display:flex;flex-wrap:wrap;gap:6px;">
                        {% for k,v in top[:8] %}
                    <span class="chip" style="background:var(--gray-100);">{{ k }}<span style="color:var(--primary);font-weight:600;margin-left:4px;">{{ v }}</span></span>
                {% endfor %}
            </div>
            {% else %}
                <div style="font-size:var(--font-size-xs);color:var(--gray-500);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
            {% endif %}
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ -->
    <div class="table-container" style="margin-top:var(--space-8);">
        <table class="table" id="userHistoryTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–§–∞–π–ª</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–°—Ä–æ—á–Ω–æ—Å—Ç—å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for conv in conversations %}
                <tr>
                    <td style="font-size:var(--font-size-xs);color:var(--gray-500);">{{ conv.id }}</td>
                    <td style="font-weight:600;">{{ conv.filename }}</td>
                    <td style="font-size:var(--font-size-xs);white-space:nowrap;">{{ conv.upload_date.strftime('%d.%m.%Y %H:%M') }}</td>
                    <td><span class="status-chip status-{{ conv.status }}">{{ conv.status_display }}</span></td>
                    <td>
                        {% if conv.analysis %}
                            <span class="urgency-chip urgency-{{ conv.analysis.urgency or 'unknown' }}">{{ conv.analysis.urgency_display }}</span>
                        {% else %}
                            <span class="urgency-chip urgency-none">‚Äî</span>
                        {% endif %}
                    </td>
                    <td style="display:flex;gap:6px;flex-wrap:wrap;">
                        <a class="btn btn-sm btn-outline" href="{{ url_for('conversation_detail', conversation_id=conv.id) }}" title="–î–µ—Ç–∞–ª–∏"><i class="fas fa-eye"></i></a>
                        <form method="POST" action="{{ url_for('delete_conversation', conversation_id=conv.id) }}" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä?');">
                            <button type="submit" class="btn btn-sm btn-danger" title="–£–¥–∞–ª–∏—Ç—å"><i class="fas fa-trash"></i></button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <div style="text-align:center;padding:80px 20px;color:var(--gray-500);">
            <div style="font-size:4rem;">üì≠</div>
            <h3 style="margin-top:var(--space-4);color:var(--gray-800);">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤</h3>
            <p style="font-size:var(--font-size-sm);">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
        </div>
    {% endif %}
</div>

<style>
    .mini-bar {width:100%; background:linear-gradient(135deg,var(--primary),var(--secondary)); border-radius:4px; position:relative; height:0; transition:height .35s ease;}
    #userHistoryTable tbody tr { transition:var(--transition); }
    #userHistoryTable tbody tr:hover { background:var(--gray-50); }
    .status-chip { display:inline-block; padding:4px 10px; border-radius:20px; font-size:var(--font-size-xs); font-weight:600; color:var(--white); }
    .status-completed { background:var(--success); }
    .status-error { background:var(--error); }
    .status-transcribing { background:var(--info); }
    .status-analyzing { background:var(--warning); }
    .status-pending { background:var(--gray-400); }
    .urgency-chip { display:inline-block; padding:4px 10px; border-radius:12px; font-size:var(--font-size-xs); font-weight:600; }
    .urgency-low { background:var(--success); color:var(--white); }
    .urgency-medium { background:var(--info); color:var(--white); }
    .urgency-high { background:var(--warning); color:var(--white); }
    .urgency-critical { background:var(--error); color:var(--white); }
    .urgency-none { background:var(--gray-300); color:var(--gray-600); }
    .progress-outer {height:8px;background:var(--gray-200);border-radius:4px;overflow:hidden;}
    .progress-inner {height:100%;transition:width .4s ease;}
    .progress-inner.status-completed {background:var(--success);}
    .progress-inner.status-error {background:var(--error);}
    .progress-inner.status-working {background:var(--warning);}
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.mini-bar').forEach(el => {
            const h = el.getAttribute('data-h'); if(h) el.style.height = h + '%';
        });
        document.querySelectorAll('.progress-inner').forEach(el => {
            const w = el.getAttribute('data-w'); if(w) el.style.width = w + '%';
        });
    });
</script>

{% endblock %}
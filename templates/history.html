{% extends 'base.html' %}
{% block title %}–ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ - OperaMind{% endblock %}
{% block content %}

<div class="card" style="animation:fadeInUp .4s ease;">
    <div class="card-header" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:var(--space-6);margin-bottom:var(--space-4);">
        <div>
            <h2 class="card-title" style="display:flex;align-items:center;gap:var(--space-3);">
                <i class="fas fa-headset" style="color:var(--primary);"></i> –ú–æ–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã
            </h2>
            <div class="card-subtitle">–í—Å–µ –≤–∞—à–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã</div>
        </div>
        
        <form method="get" style="display:flex;gap:var(--space-3);flex-wrap:wrap;align-items:center;">
            <input type="text" name="search" value="{{ request.args.get('search', '') }}" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞" style="padding:10px 14px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:var(--font-size-sm);min-width:220px;">
            
            <select name="status" style="padding:10px 14px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:var(--font-size-sm);background:var(--white);">
                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="completed" {% if request.args.get('status') == 'completed' %}selected{% endif %}>–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                <option value="transcribing" {% if request.args.get('status') == 'transcribing' %}selected{% endif %}>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</option>
                <option value="analyzing" {% if request.args.get('status') == 'analyzing' %}selected{% endif %}>–ê–Ω–∞–ª–∏–∑</option>
                <option value="error" {% if request.args.get('status') == 'error' %}selected{% endif %}>–û—à–∏–±–∫–∞</option>
            </select>
            
            <button type="submit" class="btn btn-sm"><i class="fas fa-search"></i> –ù–∞–π—Ç–∏</button>
            <a href="{{ url_for('history') }}" class="btn btn-outline btn-sm"><i class="fas fa-undo"></i> –°–±—Ä–æ—Å</a>
        </form>
    </div>

    {% if conversations.items %}
    <div class="table-container" style="overflow-x:auto;">
        <table class="table" id="userHistoryTable">
            <thead>
                <tr>
                    <th style="width:60px;">ID</th>
                    <th>–§–∞–π–ª</th>
                    <th style="width:150px;">–î–∞—Ç–∞</th>
                    <th style="width:130px;">–°—Ç–∞—Ç—É—Å</th>
                    <th style="width:120px;">–°—Ä–æ—á–Ω–æ—Å—Ç—å</th>
                    <th style="width:220px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for conv in conversations.items %}
                <tr data-conversation-id="{{ conv.id }}">
                    <td style="font-size:var(--font-size-xs);color:var(--gray-500);">{{ conv.id }}</td>
                    <td style="font-weight:600;">{{ conv.filename }}</td>
                    <td style="font-size:var(--font-size-xs);white-space:nowrap;">{{ conv.upload_date.strftime('%d.%m.%Y %H:%M') }}</td>
                    <td><span class="status-chip status-{{ conv.status }}">{{ conv.status_display }}</span></td>
                    <td>
                        {% if conv.analysis %}
                            <span class="urgency-chip urgency-{{ conv.analysis.urgency or 'unknown' }}">{{ conv.analysis.urgency_display }}</span>
                        {% else %}
                            <span class="urgency-chip urgency-none">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group">
                            <a class="btn btn-sm btn-outline" href="{{ url_for('conversation_detail', conversation_id=conv.id) }}" title="–î–µ—Ç–∞–ª–∏">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if conv.analysis %}
                            <a class="btn btn-sm btn-success" href="{{ url_for('download_report', conversation_id=conv.id) }}" title="–°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç">
                                <i class="fas fa-download"></i>
                            </a>
                            {% endif %}
                            <form method="POST" action="{{ url_for('delete_conversation', conversation_id=conv.id) }}" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä?');" style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-danger" title="–£–¥–∞–ª–∏—Ç—å">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if conversations.pages > 1 %}
    <div style="display:flex;justify-content:center;align-items:center;gap:var(--space-3);margin-top:var(--space-6);flex-wrap:wrap;">
        {% if conversations.has_prev %}
        <a href="{{ url_for('history', page=conversations.prev_num, search=request.args.get('search',''), status=request.args.get('status','')) }}" class="btn btn-outline btn-sm">
            <i class="fas fa-chevron-left"></i> –ù–∞–∑–∞–¥
        </a>
        {% endif %}
        
        <div style="display:flex;gap:var(--space-2);">
            {% for p in range(1, conversations.pages + 1) %}
                {% if p == conversations.page %}
                <span class="btn btn-sm" style="background:var(--primary);">{{ p }}</span>
                {% elif p == 1 or p == conversations.pages or (p >= conversations.page - 2 and p <= conversations.page + 2) %}
                <a href="{{ url_for('history', page=p, search=request.args.get('search',''), status=request.args.get('status','')) }}" class="btn btn-outline btn-sm">{{ p }}</a>
                {% elif p == conversations.page - 3 or p == conversations.page + 3 %}
                <span style="color:var(--gray-500);">...</span>
                {% endif %}
            {% endfor %}
        </div>
        
        {% if conversations.has_next %}
        <a href="{{ url_for('history', page=conversations.next_num, search=request.args.get('search',''), status=request.args.get('status','')) }}" class="btn btn-outline btn-sm">
            –í–ø–µ—Ä—ë–¥ <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div style="text-align:center;padding:80px 20px;color:var(--gray-500);">
        <div style="font-size:4rem;">üì≠</div>
        <h3 style="margin-top:var(--space-4);color:var(--gray-800);">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h3>
        <p style="font-size:var(--font-size-sm);">
            {% if request.args.get('search') or request.args.get('status') %}
            –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
            {% else %}
            –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å
            {% endif %}
        </p>
    </div>
    {% endif %}
</div>

<style>
    .status-chip { 
        display:inline-block; 
        padding:4px 10px; 
        border-radius:20px; 
        font-size:var(--font-size-xs); 
        font-weight:600; 
        color:var(--white); 
    }
    .status-queued { background:#ff9800; }
    .status-completed { background:var(--success); }
    .status-error { background:var(--error); }
    .status-transcribing { background:var(--info); }
    .status-analyzing { background:var(--warning); }
    .status-pending { background:var(--gray-400); }

    .urgency-chip { 
        display:inline-block; 
        padding:4px 10px; 
        border-radius:12px; 
        font-size:var(--font-size-xs); 
        font-weight:600; 
    }
    .urgency-–Ω–∏–∑–∫–∞—è, .urgency-low { background:#4caf50; color:white; }
    .urgency-—Å—Ä–µ–¥–Ω—è—è, .urgency-medium { background:#2196f3; color:white; }
    .urgency-–≤—ã—Å–æ–∫–∞—è, .urgency-high { background:#ff9800; color:white; }
    .urgency-–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è, .urgency-critical { background:#f44336; color:white; }
    .urgency-none, .urgency-unknown { background:var(--gray-300); color:var(--gray-600); }

    .status-updated {
        animation: highlight 2s ease-in-out;
    }

    @keyframes highlight {
        0%, 100% { background-color: transparent; }
        50% { background-color: rgba(76, 175, 80, 0.2); }
    }
</style>

<script>
// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ –∏—Å—Ç–æ—Ä–∏–∏
function updateAllConversationStatuses() {
    const rows = document.querySelectorAll('tr[data-conversation-id]');
    
    rows.forEach(row => {
        const convId = row.dataset.conversationId;
        
        fetch(`/api/conversation/${convId}/status`)
            .then(response => response.json())
            .then(data => {
                const statusChip = row.querySelector('.status-chip');
                const urgencyChip = row.querySelector('.urgency-chip');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                if (statusChip && statusChip.textContent.trim() !== data.status_display) {
                    statusChip.textContent = data.status_display;
                    statusChip.className = `status-chip status-${data.status}`;
                    
                    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
                    if (data.status === 'completed') {
                        row.classList.add('status-updated');
                        setTimeout(() => row.classList.remove('status-updated'), 2000);
                        
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ä–æ—á–Ω–æ—Å—Ç–∏
                        setTimeout(() => location.reload(), 2000);
                    }
                }
            })
            .catch(err => console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', err));
    });
}

// –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
setInterval(updateAllConversationStatuses, 3000);

// –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É
updateAllConversationStatuses();
</script>

{% endblock %}